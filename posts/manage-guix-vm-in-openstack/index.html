<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploy and Manage a Guix VM in OpenStack | Polyedre</title>
<meta name=keywords content><meta name=description content="It&rsquo;s been a few months since I started using Guix as the Operating System of my personal laptop. I&rsquo;m found of how easy
it is to enable some services or install packages. Now that I&rsquo;ve become more familiar with Guile as a programming
language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and
used guix deploy to manage this VM. This post summarize my experience doing so."><meta name=author content="Polyedre"><link rel=canonical href=https://polyedre.github.io/posts/manage-guix-vm-in-openstack/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://polyedre.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://polyedre.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://polyedre.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://polyedre.github.io/apple-touch-icon.png><link rel=mask-icon href=https://polyedre.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://polyedre.github.io/posts/manage-guix-vm-in-openstack/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PL8DXXK8VN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PL8DXXK8VN")}</script><meta property="og:title" content="Deploy and Manage a Guix VM in OpenStack"><meta property="og:description" content="It&rsquo;s been a few months since I started using Guix as the Operating System of my personal laptop. I&rsquo;m found of how easy
it is to enable some services or install packages. Now that I&rsquo;ve become more familiar with Guile as a programming
language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and
used guix deploy to manage this VM. This post summarize my experience doing so."><meta property="og:type" content="article"><meta property="og:url" content="https://polyedre.github.io/posts/manage-guix-vm-in-openstack/"><meta property="og:image" content="https://polyedre.github.io/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-17T12:42:19+02:00"><meta property="article:modified_time" content="2025-05-17T12:42:19+02:00"><meta property="og:site_name" content="Polyedre"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://polyedre.github.io/"><meta name=twitter:title content="Deploy and Manage a Guix VM in OpenStack"><meta name=twitter:description content="It&rsquo;s been a few months since I started using Guix as the Operating System of my personal laptop. I&rsquo;m found of how easy
it is to enable some services or install packages. Now that I&rsquo;ve become more familiar with Guile as a programming
language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and
used guix deploy to manage this VM. This post summarize my experience doing so."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://polyedre.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Deploy and Manage a Guix VM in OpenStack","item":"https://polyedre.github.io/posts/manage-guix-vm-in-openstack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploy and Manage a Guix VM in OpenStack","name":"Deploy and Manage a Guix VM in OpenStack","description":"It\u0026rsquo;s been a few months since I started using Guix as the Operating System of my personal laptop. I\u0026rsquo;m found of how easy it is to enable some services or install packages. Now that I\u0026rsquo;ve become more familiar with Guile as a programming language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and used guix deploy to manage this VM. This post summarize my experience doing so.\n","keywords":[],"articleBody":"It’s been a few months since I started using Guix as the Operating System of my personal laptop. I’m found of how easy it is to enable some services or install packages. Now that I’ve become more familiar with Guile as a programming language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and used guix deploy to manage this VM. This post summarize my experience doing so.\nBuilding the QCow2 image locally Creating a QCow2 image with Guix was so easy I was sure the VM would not boot the first time (there’s not way right?). I can even claim that it is as easy as writing a Dockerfile to create a OCI container.\nThe first step was to define an operating-system. I tweaked some example I found online, and got this:\nimage.scm (use-modules (gnu) (nongnu packages linux) (guix packages) (guix build-system copy)) (use-service-modules networking ssh web) (use-package-modules bootloaders ssh web version-control) (operating-system (kernel linux) (firmware (list linux-firmware)) (host-name \"guix-1\") (locale \"en_US.utf8\") (timezone \"Europe/Paris\") (keyboard-layout (keyboard-layout \"fr\")) (bootloader (bootloader-configuration (bootloader grub-bootloader) (target \"/dev/vda\") (terminal-outputs '(console)))) (file-systems (cons (file-system (mount-point \"/\") (device \"/dev/vda1\") (type \"ext4\")) %base-file-systems)) (services (append (list (service dhcp-client-service-type) (service openssh-service-type (openssh-configuration (openssh openssh-sans-x) (permit-root-login #t) (authorized-keys ;; Authorise our SSH key. `((\"root\" ,(local-file \"/home/polyedre/.ssh/id_rsa.pub\")) (\"polyedre\" ,(local-file \"/home/polyedre/.ssh/id_rsa.pub\"))))))) (modify-services %base-services (guix-service-type config =\u003e (guix-configuration (inherit config) (authorized-keys (append (list (local-file \"/etc/guix/signing-key.pub\")) %default-authorized-guix-keys)))))))) This file declares an operating system that uses the Linux Kernel and additionnal non-free firmware drivers, and enable two important services:\na DHCP client to get the IP automatically an OpenSSH daemon that authorize connection to the root user with the public key read from my local laptop. With this, you are one simple command away from building your image:\nguix system image --root=guix-result --image-type=qcow2 image.scm The flag --root ask guix to create a symlink named guix-result that point to the artifact that will be built.\nBecause guix-result is a read-only artifact, to boot the machine locally for testing purpose you will have to copy the file to a writable folder:\ncp guix-result guix.qcow2 You can start the virtual machine using qemu:\nguix shell qemu -- sudo qemu-system-x86_64 -nic user,model=virtio-net-pci -enable-kvm -m 2048 -device virtio-blk,drive=guix-demo -drive if=none,file=guix.qcow2,id=guix-demo Uploading the Qcow2 image and starting a VM from it In this section, I will assume some basic knowledge of how to use OpenStack. To install OpenStack’s CLI, just use pip:\npip install python-openstackclient You will then be able to upload the image:\nopenstack image create \\ --progress \\ --disk-format qcow2 \\ --container-format bare \\ --file guix-result \\ --property hypervisor_type=kvm \\ --property os_type=linux \\ --property os_admin_user=root \\ --property os_distro=guixsystem \\ --property os_version=unknown \\ guix And start the VM. The OVHcloud OpenStack installation provides public IPs using the Ext-Net subnet. I’ll start a VM named guix-1 with 8 Go of memory:\nopenstack server create \\ --image guix \\ --network Ext-Net \\ --flavor b3-8 \\ --key-name laptop \\ guix-1 After a minute or two, the VM is ready and I can connect to it with SSH:\n$ openstack server list +--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+ | ID | Name | Status | Networks | Image | Flavor | +--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+ | af308c4e-8064-44c3-8ced-ed7c112478eb | guix-1 | ACTIVE | Ext-Net=2001:41d0:304:300::627d, 217.182.210.193 | guix | b3-8 | +--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+ $ ssh root@217.182.210.193 Last login: Fri May 16 17:50:33 2025 from 81.65.157.5 root@guix-1 ~# The image we built does not include cloud-init. So you will have to resize the partition manually before running resize2fs!\nManage the VM remotely using guix deploy Starting a VM from an image that we just built was great, but what about day-2 management of the VM? We had a declarative configuration to build the image. Can we have the same to manage our remote VM? How to add users, packages or services?\nLet’s see!\nTo use guix deploy, we need a file that list all the machines that are managed with their configuration. Let’s reuse our operating-system resource written in image.scm.\ndeploy.scm (use-service-modules networking ssh) (use-package-modules bootloaders ssh) (define os (load \"image.scm\")) (list (machine (operating-system os) (environment managed-host-environment-type) (configuration (machine-ssh-configuration (host-name \"217.182.210.193\") (system \"x86_64-linux\") (user \"root\") (host-key #f) (port 22))))) This file define a single machine managed through SSH.\nTo apply the configuration to the remote machine, you are just a deploy away!\nguix deploy deploy.scm By default, Guix will build all the artifacts locally, and then send them to the server.\nYou can now add users, packages or services and deploy again:\n(use-modules (gnu) (nongnu packages linux) (guix packages) (guix build-system copy)) (use-service-modules networking ssh web) (use-package-modules bootloaders ssh web version-control) (operating-system (kernel linux) (firmware (list linux-firmware)) (host-name \"guix-1\") (locale \"en_US.utf8\") (timezone \"Europe/Paris\") (keyboard-layout (keyboard-layout \"fr\")) + (users (cons* (user-account + (name \"polyedre\") + (comment \"Polyedre\") + (group \"users\") + (home-directory (string-append \"/home/\" \"polyedre\")) + (supplementary-groups '(\"wheel\" \"netdev\" \"audio\" \"video\"))) + %base-user-accounts)) + (packages (cons* git + %base-packages)) (bootloader (bootloader-configuration (bootloader grub-bootloader) (target \"/dev/vda\") (terminal-outputs '(console)))) (file-systems (cons (file-system (mount-point \"/\") (device \"/dev/vda1\") (type \"ext4\")) %base-file-systems)) (services (append (list (service dhcp-client-service-type) (service openssh-service-type (openssh-configuration (openssh openssh-sans-x) (permit-root-login #t) (authorized-keys ;; Authorise our SSH key. `((\"root\" ,(local-file \"/home/polyedre/.ssh/id_rsa.pub\")) (\"polyedre\" ,(local-file \"/home/polyedre/.ssh/id_rsa.pub\")))))) + (service nginx-service-type + (nginx-configuration + (server-blocks + (list + (nginx-server-configuration + (listen '(\"8080\")) + (server-name '(\"www.polyed.re\")) + (root (file-union \"nginx-root\" + `((\"index.html\" ,(local-file \"./index.html\"))))))))))) (modify-services %base-services (guix-service-type config =\u003e (guix-configuration (inherit config) (authorized-keys (append (list (local-file \"/etc/guix/signing-key.pub\")) %default-authorized-guix-keys)))))))) ","wordCount":"883","inLanguage":"en","image":"https://polyedre.github.io/","datePublished":"2025-05-17T12:42:19+02:00","dateModified":"2025-05-17T12:42:19+02:00","author":{"@type":"Person","name":"Polyedre"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://polyedre.github.io/posts/manage-guix-vm-in-openstack/"},"publisher":{"@type":"Organization","name":"Polyedre","logo":{"@type":"ImageObject","url":"https://polyedre.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://polyedre.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://polyedre.github.io/profile.jpeg alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://polyedre.github.io/posts/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://polyedre.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://polyedre.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Deploy and Manage a Guix VM in OpenStack</h1><div class=post-meta><span title='2025-05-17 12:42:19 +0200 +0200'>May 17, 2025</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Polyedre&nbsp;|&nbsp;<a href=https://github.com/polyedre/polyedre.github.io/content/posts/manage-guix-VM-in-openstack.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>It&rsquo;s been a few months since I started using Guix as the Operating System of my personal laptop. I&rsquo;m found of how easy
it is to enable some services or install packages. Now that I&rsquo;ve become more familiar with Guile as a programming
language, I took some time to deploy a Virtual Machine in OpenStack (through the Public Cloud offering of OVHcloud), and
used <code>guix deploy</code> to manage this VM. This post summarize my experience doing so.</p><h1 id=building-the-qcow2-image-locally>Building the QCow2 image locally<a hidden class=anchor aria-hidden=true href=#building-the-qcow2-image-locally>#</a></h1><p>Creating a QCow2 image with Guix was so easy I was sure the VM would not boot the first time (there&rsquo;s not way right?). I
can even claim that it is as easy as writing a Dockerfile to create a OCI container.</p><p>The first step was to define an
<a href=https://guix.gnu.org/manual/en/html_node/operating_002dsystem-Reference.html>operating-system</a>. I tweaked some example
I found online, and got this:</p><h4 id=imagescm><strong>image.scm</strong><a hidden class=anchor aria-hidden=true href=#imagescm>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>use-modules</span> (<span style=color:#a6e22e>gnu</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>nongnu</span> packages linux)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>guix</span> packages)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>guix</span> build-system copy))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>use-service-modules</span> networking ssh web)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>use-package-modules</span> bootloaders ssh web version-control)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>operating-system</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>kernel</span> linux)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>firmware</span> (list linux-firmware))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>host-name</span> <span style=color:#e6db74>&#34;guix-1&#34;</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>locale</span> <span style=color:#e6db74>&#34;en_US.utf8&#34;</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>timezone</span> <span style=color:#e6db74>&#34;Europe/Paris&#34;</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>keyboard-layout</span> (<span style=color:#a6e22e>keyboard-layout</span> <span style=color:#e6db74>&#34;fr&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>bootloader</span> (<span style=color:#a6e22e>bootloader-configuration</span>
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>bootloader</span> grub-bootloader)
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>target</span> <span style=color:#e6db74>&#34;/dev/vda&#34;</span>)
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>terminal-outputs</span> <span style=color:#f92672>&#39;</span>(console))))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>file-systems</span> (cons (<span style=color:#a6e22e>file-system</span>
</span></span><span style=display:flex><span>                        (<span style=color:#a6e22e>mount-point</span> <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>                        (<span style=color:#a6e22e>device</span> <span style=color:#e6db74>&#34;/dev/vda1&#34;</span>)
</span></span><span style=display:flex><span>                        (<span style=color:#a6e22e>type</span> <span style=color:#e6db74>&#34;ext4&#34;</span>))
</span></span><span style=display:flex><span>                      %base-file-systems))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>services</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>append</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>service</span> dhcp-client-service-type)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>service</span> openssh-service-type
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>openssh-configuration</span>
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>openssh</span> openssh-sans-x)
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>permit-root-login</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>authorized-keys</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>;; Authorise our SSH key.</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>`</span>((<span style=color:#e6db74>&#34;root&#34;</span> <span style=color:#f92672>,</span>(<span style=color:#a6e22e>local-file</span> <span style=color:#e6db74>&#34;/home/polyedre/.ssh/id_rsa.pub&#34;</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#e6db74>&#34;polyedre&#34;</span> <span style=color:#f92672>,</span>(<span style=color:#a6e22e>local-file</span> <span style=color:#e6db74>&#34;/home/polyedre/.ssh/id_rsa.pub&#34;</span>)))))))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>modify-services</span> %base-services
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>guix-service-type</span> config =&gt;
</span></span><span style=display:flex><span>                         (<span style=color:#a6e22e>guix-configuration</span>
</span></span><span style=display:flex><span>                          (<span style=color:#a6e22e>inherit</span> config)
</span></span><span style=display:flex><span>                          (<span style=color:#a6e22e>authorized-keys</span> (append (list (<span style=color:#a6e22e>local-file</span> <span style=color:#e6db74>&#34;/etc/guix/signing-key.pub&#34;</span>)) %default-authorized-guix-keys))))))))
</span></span></code></pre></div><p>This file declares an operating system that uses the Linux Kernel and additionnal non-free firmware drivers, and enable
two important services:</p><ul><li>a DHCP client to get the IP automatically</li><li>an OpenSSH daemon that authorize connection to the root user with the public key read from my local laptop.</li></ul><p>With this, you are one simple command away from building your image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>guix system image --root<span style=color:#f92672>=</span>guix-result --image-type<span style=color:#f92672>=</span>qcow2 image.scm
</span></span></code></pre></div><p>The flag <code>--root</code> ask guix to create a symlink named <code>guix-result</code> that point to the artifact that will be built.</p><p>Because <code>guix-result</code> is a read-only artifact, to boot the machine locally for testing purpose you will have to copy the
file to a writable folder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp guix-result guix.qcow2
</span></span></code></pre></div><p>You can start the virtual machine using qemu:</p><pre tabindex=0><code>guix shell qemu -- sudo qemu-system-x86_64 -nic user,model=virtio-net-pci -enable-kvm -m 2048 -device virtio-blk,drive=guix-demo -drive if=none,file=guix.qcow2,id=guix-demo
</code></pre><h1 id=uploading-the-qcow2-image-and-starting-a-vm-from-it>Uploading the Qcow2 image and starting a VM from it<a hidden class=anchor aria-hidden=true href=#uploading-the-qcow2-image-and-starting-a-vm-from-it>#</a></h1><p>In this section, I will assume some basic knowledge of how to use OpenStack. To install OpenStack&rsquo;s CLI, just use pip:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install python-openstackclient
</span></span></code></pre></div><p>You will then be able to upload the image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openstack image create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --progress <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --disk-format qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --container-format bare <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --file guix-result <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --property hypervisor_type<span style=color:#f92672>=</span>kvm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --property os_type<span style=color:#f92672>=</span>linux <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --property os_admin_user<span style=color:#f92672>=</span>root <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --property os_distro<span style=color:#f92672>=</span>guixsystem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --property os_version<span style=color:#f92672>=</span>unknown <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          guix
</span></span></code></pre></div><p>And start the VM. The OVHcloud OpenStack installation provides public IPs using the <code>Ext-Net</code> subnet. I&rsquo;ll start a VM
named <code>guix-1</code> with 8 Go of memory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openstack server create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --image guix <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --network Ext-Net <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --flavor b3-8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          --key-name laptop <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>          guix-1
</span></span></code></pre></div><p>After a minute or two, the VM is ready and I can connect to it with SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openstack server list
</span></span><span style=display:flex><span>+--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+
</span></span><span style=display:flex><span>| ID                                   | Name   | Status | Networks                                         | Image | Flavor |
</span></span><span style=display:flex><span>+--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+
</span></span><span style=display:flex><span>| af308c4e-8064-44c3-8ced-ed7c112478eb | guix-1 | ACTIVE | Ext-Net<span style=color:#f92672>=</span>2001:41d0:304:300::627d, 217.182.210.193 | guix  | b3-8   |
</span></span><span style=display:flex><span>+--------------------------------------+--------+--------+--------------------------------------------------+-------+--------+
</span></span><span style=display:flex><span>$ ssh root@217.182.210.193
</span></span><span style=display:flex><span>Last login: Fri May <span style=color:#ae81ff>16</span> 17:50:33 <span style=color:#ae81ff>2025</span> from 81.65.157.5
</span></span><span style=display:flex><span>root@guix-1 ~# 
</span></span></code></pre></div><p>The image we built does not include <code>cloud-init</code>. So you will have to resize the partition manually before running <code>resize2fs</code>!</p><h1 id=manage-the-vm-remotely-using-guix-deploy>Manage the VM remotely using <code>guix deploy</code><a hidden class=anchor aria-hidden=true href=#manage-the-vm-remotely-using-guix-deploy>#</a></h1><p>Starting a VM from an image that we just built was great, but what about day-2 management of the VM? We had a
declarative configuration to build the image. Can we have the same to manage our remote VM? How to add users, packages
or services?</p><p>Let&rsquo;s see!</p><p>To use <code>guix deploy</code>, we need a file that list all the machines that are managed with their configuration. Let&rsquo;s reuse
our <code>operating-system</code> resource written in <code>image.scm</code>.</p><h4 id=deployscm><strong>deploy.scm</strong><a hidden class=anchor aria-hidden=true href=#deployscm>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>use-service-modules</span> networking ssh)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>use-package-modules</span> bootloaders ssh)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>os (load <span style=color:#e6db74>&#34;image.scm&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(list (<span style=color:#a6e22e>machine</span>
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>operating-system</span> os)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>environment</span> managed-host-environment-type)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>configuration</span> (<span style=color:#a6e22e>machine-ssh-configuration</span>
</span></span><span style=display:flex><span>                       (<span style=color:#a6e22e>host-name</span> <span style=color:#e6db74>&#34;217.182.210.193&#34;</span>)
</span></span><span style=display:flex><span>                       (<span style=color:#a6e22e>system</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>)
</span></span><span style=display:flex><span>                       (<span style=color:#a6e22e>user</span> <span style=color:#e6db74>&#34;root&#34;</span>)
</span></span><span style=display:flex><span>                       (<span style=color:#a6e22e>host-key</span> <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>                       (<span style=color:#a6e22e>port</span> <span style=color:#ae81ff>22</span>)))))
</span></span></code></pre></div><p>This file define a single machine managed through SSH.</p><p>To apply the configuration to the remote machine, you are just a <code>deploy</code> away!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>guix deploy deploy.scm
</span></span></code></pre></div><p>By default, Guix will build all the artifacts locally, and then send them to the server.</p><p>You can now add users, packages or services and deploy again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>(use-modules (gnu)
</span></span><span style=display:flex><span>             (nongnu packages linux)
</span></span><span style=display:flex><span>             (guix packages)
</span></span><span style=display:flex><span>             (guix build-system copy))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(use-service-modules networking ssh web)
</span></span><span style=display:flex><span>(use-package-modules bootloaders ssh web version-control)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(operating-system
</span></span><span style=display:flex><span>  (kernel linux)
</span></span><span style=display:flex><span>  (firmware (list linux-firmware))
</span></span><span style=display:flex><span>  (host-name &#34;guix-1&#34;)
</span></span><span style=display:flex><span>  (locale &#34;en_US.utf8&#34;)
</span></span><span style=display:flex><span>  (timezone &#34;Europe/Paris&#34;)
</span></span><span style=display:flex><span>  (keyboard-layout (keyboard-layout &#34;fr&#34;))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  (users (cons* (user-account
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (name &#34;polyedre&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (comment &#34;Polyedre&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (group &#34;users&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (home-directory (string-append &#34;/home/&#34; &#34;polyedre&#34;))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (supplementary-groups &#39;(&#34;wheel&#34; &#34;netdev&#34; &#34;audio&#34; &#34;video&#34;)))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                %base-user-accounts))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  (packages (cons* git
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                   %base-packages))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>  (bootloader (bootloader-configuration
</span></span><span style=display:flex><span>               (bootloader grub-bootloader)
</span></span><span style=display:flex><span>               (target &#34;/dev/vda&#34;)
</span></span><span style=display:flex><span>               (terminal-outputs &#39;(console))))
</span></span><span style=display:flex><span>  (file-systems (cons (file-system
</span></span><span style=display:flex><span>                        (mount-point &#34;/&#34;)
</span></span><span style=display:flex><span>                        (device &#34;/dev/vda1&#34;)
</span></span><span style=display:flex><span>                        (type &#34;ext4&#34;))
</span></span><span style=display:flex><span>                      %base-file-systems))
</span></span><span style=display:flex><span>  (services
</span></span><span style=display:flex><span>   (append
</span></span><span style=display:flex><span>    (list
</span></span><span style=display:flex><span>     (service dhcp-client-service-type)
</span></span><span style=display:flex><span>     (service openssh-service-type
</span></span><span style=display:flex><span>              (openssh-configuration
</span></span><span style=display:flex><span>               (openssh openssh-sans-x)
</span></span><span style=display:flex><span>               (permit-root-login #t)
</span></span><span style=display:flex><span>               (authorized-keys
</span></span><span style=display:flex><span>                ;; Authorise our SSH key.
</span></span><span style=display:flex><span>                `((&#34;root&#34; ,(local-file &#34;/home/polyedre/.ssh/id_rsa.pub&#34;))
</span></span><span style=display:flex><span>                  (&#34;polyedre&#34; ,(local-file &#34;/home/polyedre/.ssh/id_rsa.pub&#34;))))))
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    (service nginx-service-type
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             (nginx-configuration
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+              (server-blocks
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               (list
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                (nginx-server-configuration
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (listen &#39;(&#34;8080&#34;))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (server-name &#39;(&#34;www.polyed.re&#34;))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                 (root (file-union &#34;nginx-root&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                   `((&#34;index.html&#34; ,(local-file &#34;./index.html&#34;)))))))))))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>    (modify-services %base-services
</span></span><span style=display:flex><span>      (guix-service-type config =&gt;
</span></span><span style=display:flex><span>                         (guix-configuration
</span></span><span style=display:flex><span>                          (inherit config)
</span></span><span style=display:flex><span>                          (authorized-keys (append (list (local-file &#34;/etc/guix/signing-key.pub&#34;)) %default-authorized-guix-keys))))))))
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://polyedre.github.io/posts/why-2767-nodeports/><span class=title>Next »</span><br><span>Why Kubernetes NodePort Stops at 32767?</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://polyedre.github.io/>Polyedre</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>